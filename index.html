<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Finance Monitoring</title>
<style>
/* Reset */
* {
    box-sizing: border-box;
}
body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9fafb;
    color: #333;
    display: flex;
    flex-direction: column;
    height: 100vh;
    max-height: 600px;
    max-width: 350px;
    margin: 0 auto;
}
/* Container */
#app {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    padding: 1rem;
    overflow: hidden;
}
/* Dashboard */
#dashboard {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-y: auto;
}
.balance {
    margin-top: 0.4rem;
    background-color: #2c3e50;
    color: #ecf0f1;
    font-size: 2.2rem;
    font-weight: 700;
    padding: 1rem 2rem;
    border-radius: 12px;
    width: fit-content;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.copyright {
    margin-top: 1rem;
    font-size: 0.85rem;
    color: #888;
    user-select: none;
}
.copyright a {
    color: #888;
    text-decoration: none;
    cursor: pointer;
}
.copyright a:hover,
.copyright a:focus {
    color: #2980b9;
    outline: none;
    text-decoration: underline;
}
.income-expense-container {
    margin-top: 1rem;
    width: 100%;
    display: flex;
    justify-content: space-around;
    gap: 1rem;
}
.card {
    flex: 1;
    background: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.05);
    display: flex;
    flex-direction: column;
    align-items: center;
    font-weight: 600;
    min-width: 0;
}
.card.income {
    border-left: 4px solid #27ae60; /* green */
}
.card.expense {
    border-left: 4px solid #c0392b; /* red */
}
.card .amount {
    font-size: 1.5rem;
    margin-top: 0.3rem;
    color: inherit;
}
.chart-controls {
    margin-top: 1.5rem;
    display: flex;
    justify-content: center;
    gap: 0.8rem;
}
.chart-controls button {
    background: transparent;
    border: 2px solid #7f8c8d;
    padding: 0.3rem 0.8rem;
    font-weight: 600;
    font-size: 0.9rem;
    color: #7f8c8d;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 60px;
    position: relative;
    overflow: hidden;
    outline-offset: 0;
}
.chart-controls button.active {
    background: #2980b9;
    border-color: #2980b9;
    color: white;
}
.chart-controls button::after {
    content: "";
    position: absolute;
    border-radius: 50%;
    width: 100px;
    height: 100px;
    top: 50%;
    left: 50%;
    pointer-events: none;
    background: rgba(41, 128, 185, 0.3);
    transform: translate(-50%, -50%) scale(0);
    transition: transform 0.3s ease, opacity 0.5s ease;
    opacity: 0;
    z-index: 1;
}
.chart-controls button:active::after {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
    transition: transform 0s, opacity 0.5s ease;
}
.chart-container {
    margin-top: 1rem;
    width: 100%;
    max-width: 100%;
    height: 180px;
}
/* Mutation summary container */
.mutation-summary {
    margin-top: 1rem;
    width: 100%;
    max-width: 350px;
    display: flex;
    justify-content: space-around;
    padding: 0.8rem 1rem;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.mutation-box {
    flex: 1;
    padding: 0.5rem;
    border-radius: 10px;
    text-align: center;
    font-weight: 600;
}
.mutation-box.income {
    background: #e6f4ea;
    color: #27ae60;
}
.mutation-box.expense {
    background: #fbe9e7;
    color: #c0392b;
}
/* Transaksi UI */
#transaction {
    flex-direction: column;
    display: none;
    padding: 1rem 0 0 0;
    align-items: center;
    color: #333;
    height: 100%;
    overflow-y: auto;
}
.transaction-buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
    width: 100%;
    margin-bottom: 1rem;
}
.transaction-button {
    flex: 1;
    padding: 0.75rem 0;
    font-weight: 700;
    font-size: 1.1rem;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 3px 7px rgba(0,0,0,0.08);
    transition: background-color 0.2s ease, box-shadow 0.2s ease;
    position: relative;
    overflow: hidden;
    text-align: center;
    white-space: nowrap;
}
.transaction-button:focus {
    outline: 3px solid #2980b9;
    outline-offset: 2px;
}
.transaction-button.pemasukan {
    background-color: #27ae60;
    color: white;
}
.transaction-button.pemasukan:hover {
    background-color: #219150;
    box-shadow: 0 6px 12px rgba(39,174,96,0.5);
}
.transaction-button.pengeluaran {
    background-color: #c0392b;
    color: white;
}
.transaction-button.pengeluaran:hover {
    background-color: #a83224;
    box-shadow: 0 6px 12px rgba(192,57,43,0.5);
}
/* ripple for transaction buttons */
.transaction-button::after {
    content: "";
    position: absolute;
    border-radius: 50%;
    width: 120px;
    height: 120px;
    top: 50%;
    left: 50%;
    pointer-events: none;
    background: rgba(255,255,255,0.4);
    transform: translate(-50%, -50%) scale(0);
    transition: transform 0.3s ease, opacity 0.5s ease;
    opacity: 0;
    z-index: 1;
}
.transaction-button:active::after {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
    transition: transform 0s, opacity 0.5s ease;
}
/* Expanded and collapsed button styles */
.transaction-button.expanded {
    flex: none;
    width: 100%;
}
/* Hide collapsed button */
.transaction-button.collapsed {
    display: none;
}
form.transaction-form {
    width: 100%;
    max-width: 320px;
    background: white;
    padding: 1rem 1.25rem;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
form.transaction-form label {
    font-weight: 600;
    margin-bottom: 0.3rem;
    display: block;
}
form.transaction-form input[type="text"],
form.transaction-form input[type="date"] {
    width: 100%;
    padding: 0.5rem 0.8rem;
    border-radius: 8px;
    border: 1.5px solid #bdc3c7;
    font-size: 1rem;
    transition: border-color 0.2s ease;
    font-family: inherit;
}
form.transaction-form input:focus {
    outline: none;
    border-color: #2980b9;
    box-shadow: 0 0 5px rgba(41,128,185,0.5);
}
.currency-prefix {
    position: relative;
}
.currency-prefix input {
    padding-left: 2.5rem;
}
.currency-prefix::before {
    content: "Rp";
    position: absolute;
    left: 0.8rem;
    top: 50%;
    transform: translateY(-50%);
    font-weight: 600;
    color: #555;
}
.category-select-container {
    display: flex;
    flex-direction: column;
}
.category-buttons {
    margin-top: 0.3rem;
    display: flex;
    gap: 0.6rem;
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.category-btn {
    background: #ecf0f1;
    color: #333;
    font-weight: 600;
    font-size: 0.9rem;
    border-radius: 12px;
    padding: 0.3rem 0.8rem;
    display: flex;
    align-items: center;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: background-color 0.2s ease;
    border: 1px solid transparent;
}
.category-btn svg {
    width: 16px;
    height: 16px;
    margin-right: 5px;
    fill: #555;
    flex-shrink: 0;
}
.category-btn:hover,
.category-btn:focus {
    background: #2980b9;
    color: white;
    outline: none;
    border-color: #2980b9;
}
.category-btn.selected {
    background: #2980b9;
    color: white;
    border-color: #2980b9;
}
form.transaction-form button.submit-btn {
    background-color: #2980b9;
    color: white;
    padding: 0.75rem 0;
    font-size: 1rem;
    font-weight: 700;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
    position: relative;
    overflow: hidden;
}
form.transaction-form button.submit-btn:hover,
form.transaction-form button.submit-btn:focus {
    background-color: #1e5491;
    outline: none;
}
form.transaction-form button.submit-btn::after {
    content: "";
    position: absolute;
    border-radius: 50%;
    width: 150px;
    height: 150px;
    top: 50%;
    left: 50%;
    pointer-events: none;
    background: rgba(255,255,255,0.4);
    transform: translate(-50%, -50%) scale(0);
    transition: transform 0.3s ease, opacity 0.5s ease;
    opacity: 0;
    z-index: 1;
}
form.transaction-form button.submit-btn:active::after {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
    transition: transform 0s, opacity 0.5s ease;
}
/* Bottom Navigation */
nav.bottom-nav {
    flex-shrink: 0;
    background: white;
    box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-around;
    padding: 0.4rem 0;
    border-top-left-radius: 14px;
    border-top-right-radius: 14px;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
}

nav.bottom-nav button {
    background: none;
    border: none;
    outline: none;
    font-weight: 600;
    font-size: 0.9rem;
    color: #95a5a6;
    padding: 0.5rem 0.5rem 0.6rem 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: color 0.3s ease;
    flex: 1;
    position: relative;
    overflow: hidden;
}
nav.bottom-nav button.active {
    color: #2980b9;
    border-top: 3px solid #2980b9;
}
nav.bottom-nav button svg {
    margin-bottom: 2px;
    width: 22px;
    height: 22px;
    fill: currentColor;
}
nav.bottom-nav button::after {
    content: "";
    position: absolute;
    border-radius: 50%;
    width: 120px;
    height: 120px;
    top: 50%;
    left: 50%;
    pointer-events: none;
    background: rgba(41,128,185,0.3);
    transform: translate(-50%, -50%) scale(0);
    transition: transform 0.3s ease, opacity 0.5s ease;
    opacity: 0;
    z-index: 1;
}
nav.bottom-nav button:active::after {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
    transition: transform 0s, opacity 0.5s ease;
}
/* Scrollbar */
#dashboard::-webkit-scrollbar,
#transaction::-webkit-scrollbar,
#history::-webkit-scrollbar {
    width: 6px;
}
#dashboard::-webkit-scrollbar-thumb,
#transaction::-webkit-scrollbar-thumb,
#history::-webkit-scrollbar-thumb {
    background-color: #bdc3c7;
    border-radius: 3px;
}
/* Responsive */
@media (max-width: 380px) {
    .balance {
        font-size: 1.8rem;
        padding: 0.8rem 1.6rem;
    }
    .card .amount {
        font-size: 1.3rem;
    }
    .chart-controls button {
        min-width: 50px;
        padding: 0.25rem 0.6rem;
        font-size: 0.8rem;
    }
    nav.bottom-nav button {
        font-size: 0.8rem;
    }
    .transaction-button {
        font-size: 1rem;
        padding: 0.7rem 0;
    }
    form.transaction-form {
        max-width: 100%;
    }
}
/* History section */
#history {
    display: none;
    flex-direction: column;
    padding: 0.5rem 0;
    overflow-y: auto;
}
#historySearch {
    margin-bottom: 0.75rem;
    padding: 0.5rem 0.75rem;
    width: 100%;
    font-size: 1rem;
    border-radius: 8px;
    border: 1.5px solid #bdc3c7;
    outline: none;
    font-family: inherit;
    transition: border-color 0.2s ease;
}
#historySearch:focus {
    border-color: #2980b9;
    box-shadow: 0 0 5px rgba(41,128,185,0.5);
}
#filterContainer {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
}
#filterContainer select,
#filterContainer input[type="date"] {
    width: 48%;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    border: 1.5px solid #bdc3c7;
    outline: none;
    font-family: inherit;
    transition: border-color 0.2s ease;
}
#filterContainer select:focus,
#filterContainer input[type="date"]:focus {
    border-color: #2980b9;
    box-shadow: 0 0 5px rgba(41,128,185,0.5);
}
#historyList {
    list-style: none;
    padding: 0;
    margin: 0;
}
#historyList li {
    background: #fff;
    border-radius: 10px;
    margin: 5px 0;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
#historyList li div.info {
    flex: 1;
    margin-right: 10px;
}
#historyList li div.info strong {
    font-weight: 700;
}
#historyList li div.amount {
    font-weight: 700;
    min-width: 90px;
    text-align: right;
}
#historyList li div.amount.income {
    color: #27ae60;
}
#historyList li div.amount.expense {
    color: #c0392b;
}
#historyList li div.actions {
    display: flex;
    gap: 8px;
}
#historyList li div.actions button {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #2980b9;
}
#history List li div.actions button.delete {
    color: #c0392b;
}
#historyList li div.actions button svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    fill: none;
}
#noHistory {
    text-align: center;
    color: #7f8c8d;
    margin-top: 1rem;
}
</style>
</head>
<body>
<div id="app">
    <section id="dashboard" class="tab-content" style="flex-direction: column;">
        <div class="copyright">
            <a href="https://alfajrin23.github.io/personal_portofolio/" target="_blank" rel="noopener" aria-label="Copyright 2025, kunjungi website">
                © by Al Fajrin A A
            </a>
        </div>
        <div class="balance" aria-label="Saldo">Saldo: Rp 0</div>

        <div class="income-expense-container">
            <div class="card income" aria-label="Pemasukan">
                <div>Pemasukan</div>
                <div class="amount">Rp 0</div>
            </div>
            <div class="card expense" aria-label="Pengeluaran">
                <div>Pengeluaran</div>
                <div class="amount">Rp 0</div>
            </div>
        </div>
        <div class="chart-controls" role="group" aria-label="Pilih rentang waktu grafik">
            <button type="button" class="active" data-range="week" aria-pressed="true">Minggu</button>
            <button type="button" data-range="month" aria-pressed="false">Bulan</button>
            <button type="button" data-range="year" aria-pressed="false">Tahun</button>
        </div>
        <div class="chart-container">
            <canvas id="financeChart" width="300" height="180" aria-label="Grafik pemasukan dan pengeluaran" role="img"></canvas>
        </div>
        <div class="mutation-summary" aria-label="Ringkasan mutasi">
            <div class="mutation-box income">
                <div>Pemasukan</div>
                <div class="mutation-amount">Rp 0</div>
            </div>
            <div class="mutation-box expense">
                <div>Pengeluaran</div>
                <div class="mutation-amount">Rp 0</div>
            </div>
        </div>
    </section>

    <section id="transaction" class="tab-content">
        <div class="transaction-buttons" role="group" aria-label="Pilih jenis transaksi">
            <button type="button" class="transaction-button pemasukan" aria-pressed="false" id="btnPemasukan">
                Pemasukan
            </button>
            <button type="button" class="transaction-button pengeluaran" aria-pressed="false" id="btnPengeluaran">
                Pengeluaran
            </button>
        </div>
        <form class="transaction-form" style="display:none;" aria-label="Formulir transaksi" id="transactionForm">
            <div class="currency-prefix">
                <label for="jumlah">Jumlah (Rp)</label>
                <input type="text" pattern="[0-9.]*" inputmode="numeric" id="jumlah" name="jumlah" placeholder="0" required autocomplete="off" />
            </div>
            <div>
                <label for="tanggal">Hari Tanggal</label>
                <input type="date" id="tanggal" name="tanggal" required />
            </div>
            <div class="category-select-container">
                <label for="kategoriInput">Kategori</label>
                <input list="kategoriList" id="kategoriInput" name="kategori" placeholder="Pilih atau ketik kategori" autocomplete="off" />
                <datalist id="kategoriList">
                    <option value="Gaji"></option>
                    <option value="Belanja"></option>
                    <option value="Bayar"></option>
                    <option value="Tabung"></option>
                    <option value="Lainnya"></option>
                </datalist>
                <div class="category-buttons" role="list" id="categoryButtons" aria-label="Rekomendasi kategori">
                    <!-- category buttons inserted by script -->
                </div>
            </div>
            <button type="submit" class="submit-btn">Simpan</button>
        </form>
    </section>

    <section id="history" class="tab-content">
        <div id="filterContainer">
            <select id="filterType">
                <option value="all">Semua</option>
                <option value="date">Tanggal</option>
                <option value="month">Bulan</option>
                <option value="year">Tahun</option>
            </select>
            <input type="date" id="filterDate" aria-label="Pilih tanggal untuk filter" />
        </div>
        <input type="text" id="historySearch" placeholder="Cari Kategori Transaksi" aria-label="Cari kategori transaksi" />
        <ul id="historyList" aria-label="Daftar riwayat transaksi"></ul>
        <p id="noHistory">Belum ada riwayat transaksi.</p>
    </section>
</div>

<nav class="bottom-nav" role="navigation" aria-label="Navigasi menu bawah">
    <button type="button" class="active" data-tab="dashboard" aria-pressed="true" aria-label="Menu Dashboard">
        <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z"/>
        </svg>
        Dashboard
    </button>
    <button type="button" data-tab="transaction" aria-pressed="false" aria-label="Menu Transaksi">
        <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 4v16m8-8H4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
        Transaksi
    </button>
    <button type="button" data-tab="history" aria-pressed="false" aria-label="Menu Riwayat">
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        History
    </button>
</nav>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
    const tabs = document.querySelectorAll('nav.bottom-nav button');
    const sections = document.querySelectorAll('.tab-content');

    tabs.forEach(tabBtn => {
        tabBtn.addEventListener('click', () => {
            tabs.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed', 'false'); });
            sections.forEach(s => s.style.display = 'none');
            tabBtn.classList.add('active');
            tabBtn.setAttribute('aria-pressed', 'true');
            const tab = tabBtn.getAttribute('data-tab');
            const activeSection = document.getElementById(tab);
            if (activeSection) activeSection.style.display = 'flex';
        });
    });

    // Helper functions
    const formatRp = value => 'Rp ' + value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    const formatDateDisplay = dateStr => {
        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr;
        return d.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
    };
    const formatThousands = value => {
        const cleanValue = value.replace(/\D/g, '');
        if (!cleanValue) return '';
        return cleanValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    };


    // Elements
    const btnPemasukan = document.getElementById('btnPemasukan');
    const btnPengeluaran = document.getElementById('btnPengeluaran');
    const transactionForm = document.getElementById('transactionForm');
    const kategoriInput = document.getElementById('kategoriInput');
    const categoryButtonsContainer = document.getElementById('categoryButtons');
    const jumlahInput = document.getElementById('jumlah');
    const tanggalInput = document.getElementById('tanggal');
    const historyList = document.getElementById('historyList');
    const noHistory = document.getElementById('noHistory');
    const historySearch = document.getElementById('historySearch');
    const filterType = document.getElementById('filterType');
    const filterDate = document.getElementById('filterDate');
    const mutationIncomeElem = document.querySelector('.mutation-summary .mutation-box.income .mutation-amount');
    const mutationExpenseElem = document.querySelector('.mutation-summary .mutation-box.expense .mutation-amount');

    const categories = [
        { name: 'Gaji' },
        { name: 'Belanja' },
        { name: 'Bayar' },
        { name: 'Tabung' },
        { name: 'Lainnya' }
    ];

    const STORAGE_KEY = 'financeMonitoringTransactions';

    
    // Load or initialize transactions
    let transactions = [];
    const savedData = localStorage.getItem(STORAGE_KEY);
    if (savedData) {
        try {
            transactions = JSON.parse(savedData);
        } catch {
            transactions = [];
        }
    }

// Function to format the input value with dots as thousands separators
function formatInputValue(value) {
    const cleanValue = value.replace(/\D/g, ''); // Remove non-digit characters
    return cleanValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.'); // Add dots
}

// Event listener for input on the jumlah field
jumlahInput.addEventListener('input', (e) => {
    const rawValue = e.target.value;
    const formattedValue = formatInputValue(rawValue);
    e.target.value = formattedValue; // Set the formatted value back to the input
});

    function saveTransactions() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
    }

    let editIndex = -1;
    let selectedTransactionType = null;
    let currentRange = 'week';

    function renderCategoryButtons() {
        categoryButtonsContainer.innerHTML = '';
        categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'category-btn';
            btn.setAttribute('role', 'listitem');
            btn.textContent = cat.name;
            btn.title = cat.name;
            btn.addEventListener('click', () => {
                kategoriInput.value = cat.name === 'Lainnya' ? '' : cat.name;
                kategoriInput.focus();
            });
            categoryButtonsContainer.appendChild(btn);
        });
    }
    renderCategoryButtons();

    kategoriInput.addEventListener('input', () => {
        // no additional code needed for category buttons selection for now
    });

    function resetForm() {
        transactionForm.reset();
        editIndex = -1;
        selectedTransactionType = null;
        btnPemasukan.classList.remove('expanded');
        btnPengeluaran.classList.remove('expanded');
        btnPemasukan.classList.remove('collapsed');
        btnPengeluaran.classList.remove('collapsed');
        jumlahInput.value = '';
        kategoriInput.value = '';
        btnPemasukan.setAttribute('aria-pressed', 'false');
        btnPengeluaran.setAttribute('aria-pressed', 'false');
        transactionForm.style.display = 'none';
    }

    // Function to set the filter date input to today’s date
    function setTodayFilterDate() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are zero-indexed
        const dd = String(today.getDate()).padStart(2, '0');
        filterDate.value = `${yyyy}-${mm}-${dd}`; // Set the value in YYYY-MM-DD format
    }

    // Call the function to set the date filter to today
    setTodayFilterDate();


    function showForm(type, idx = -1) {
        transactionForm.style.display = 'flex';
        if (idx >= 0) {
            const tx = transactions[idx];
            editIndex = idx;
            btnPemasukan.setAttribute('aria-pressed', tx.type === 'pemasukan' ? 'true' : 'false');
            btnPengeluaran.setAttribute('aria-pressed', tx.type === 'pengeluaran' ? 'true' : 'false');
            if (tx.type === 'pemasukan') {
                btnPemasukan.classList.add('expanded');
                btnPengeluaran.classList.add('collapsed');
            } else {
                btnPengeluaran.classList.add('expanded');
                btnPemasukan.classList.add('collapsed');
            }
            selectedTransactionType = tx.type;
            jumlahInput.value = tx.amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            kategoriInput.value = tx.category;
            tanggalInput.value = tx.date;
        } else {
            editIndex = -1;
            if (type === 'pemasukan') {
                btnPemasukan.classList.add('expanded');
                btnPengeluaran.classList.add('collapsed');
                btnPemasukan.setAttribute('aria-pressed', 'true');
                btnPengeluaran.setAttribute('aria-pressed', 'false');
            } else {
                btnPengeluaran.classList.add('expanded');
                btnPemasukan.classList.add('collapsed');
                btnPengeluaran.setAttribute('aria-pressed', 'true');
                btnPemasukan.setAttribute('aria-pressed', 'false');
            }
            selectedTransactionType = type;
            transactionForm.reset();
            setTodayDate();
        }
        setTimeout(() => {
            jumlahInput.focus();
        }, 100);
    }

    btnPemasukan.addEventListener('click', () => {
        if (selectedTransactionType === 'pemasukan') {
            resetForm();
        } else {
            showForm('pemasukan');
        }
    });

    btnPengeluaran.addEventListener('click', () => {
        if (selectedTransactionType === 'pengeluaran') {
            resetForm();
        } else {
            showForm('pengeluaran');
        }
    });

    function updateDashboard() {
        let pemasukanTotal = 0;
        let pengeluaranTotal = 0;

        // Hitung total pemasukan dan pengeluaran
        transactions.forEach(tx => {
            if (tx.type === 'pemasukan') {
                pemasukanTotal += tx.amount;
            } else if (tx.type === 'pengeluaran') {
                pengeluaranTotal += tx.amount;
            }
        });

        // Update tampilan total pemasukan dan pengeluaran
        document.querySelector('.card.income .amount').textContent = formatRp(pemasukanTotal);
        document.querySelector('.card.expense .amount').textContent = formatRp(pengeluaranTotal);

        // Hitung saldo
        const saldo = pemasukanTotal - pengeluaranTotal;
        document.querySelector('.balance').textContent = `Saldo: ${formatRp(saldo)}`;
    }

    function buildChartData(range) {
        const incomeMap = new Map();
        const expenseMap = new Map();
        let labels = [];

        if (range === 'week') {
            labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            labels.forEach(day => {
                incomeMap.set(day, 0);
                expenseMap.set(day, 0);
            });
            transactions.forEach(tx => {
                const d = new Date(tx.date);
                const dayNum = d.getDay() === 0 ? 7 : d.getDay();
                const dayLabel = labels[dayNum - 1];
                if (tx.type === 'pemasukan') incomeMap.set(dayLabel, incomeMap.get(dayLabel) + tx.amount);
                else expenseMap.set(dayLabel, expenseMap.get(dayLabel) + tx.amount);
            });
        } else if (range === 'month') {
            const daysInMonth = 31;
            labels = Array.from({ length: daysInMonth }, (_, i) => (i + 1).toString());
            labels.forEach(day => {
                incomeMap.set(day, 0);
                expenseMap.set(day, 0);
            });
            transactions.forEach(tx => {
                const d = new Date(tx.date);
                let day = d.getDate().toString();
                if (incomeMap.has(day)) {
                    if (tx.type === 'pemasukan') incomeMap.set(day, incomeMap.get(day) + tx.amount);
                    else expenseMap.set(day, expenseMap.get(day) + tx.amount);
                }
            });
        } else if (range === 'year') {
            labels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            labels.forEach(month => {
                incomeMap.set(month, 0);
                expenseMap.set(month, 0);
            });
            transactions.forEach(tx => {
                const d = new Date(tx.date);
                const monthIndex = d.getMonth();
                const monthLabel = labels[monthIndex];
                if (tx.type === 'pemasukan') incomeMap.set(monthLabel, incomeMap.get(monthLabel) + tx.amount);
                else expenseMap.set(monthLabel, expenseMap.get(monthLabel) + tx.amount);
            });
        }
        return {
            labels: labels,
            income: labels.map(l => incomeMap.get(l) || 0),
            expense: labels.map(l => expenseMap.get(l) || 0)
        };
    }

    function updateChartData() {
        const { labels, income, expense } = buildChartData(currentRange);
        chart.data.labels = labels;
        chart.data.datasets[0].data = income;
        chart.data.datasets[1].data = expense;
        chart.update();

        // Update ringkasan mutasi
        const totalIncome = income.reduce((a, b) => a + b, 0);
        const totalExpense = expense.reduce((a, b) => a + b, 0);
        updateMutationSummary(totalIncome, totalExpense);
    }

    function updateMutationSummary() {
        let totalIncome = 0;
        let totalExpense = 0;

        // Hitung total pemasukan dan pengeluaran berdasarkan rentang waktu saat ini
        transactions.forEach(tx => {
            const d = new Date(tx.date);
            const now = new Date();

            // Filter berdasarkan rentang waktu
            if (currentRange === 'week' && d >= new Date(now.setDate(now.getDate() - now.getDay()))) {
                if (tx.type === 'pemasukan') {
                    totalIncome += tx.amount;
                } else if (tx.type === 'pengeluaran') {
                    totalExpense += tx.amount;
                }
            } else if (currentRange === 'month' && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                if (tx.type === 'pemasukan') {
                    totalIncome += tx.amount;
                } else if (tx.type === 'pengeluaran') {
                    totalExpense += tx.amount;
                }
            } else if (currentRange === 'year' && d.getFullYear() === now.getFullYear()) {
                if (tx.type === 'pemasukan') {
                    totalIncome += tx.amount;
                } else if (tx.type === 'pengeluaran') {
                    totalExpense += tx.amount;
                }
            }
        });

        // Update ringkasan mutasi
        mutationIncomeElem.textContent = formatRp(totalIncome);
        mutationExpenseElem.textContent = formatRp(totalExpense);
    }

    function renderHistory(filter = '') {
        historyList.innerHTML = '';
        let filtered = transactions;

        // Filter berdasarkan kategori
        if (filter.trim() !== '') {
            const lcFilter = filter.trim().toLowerCase();
            filtered = transactions.filter(tx => tx.category.toLowerCase().includes(lcFilter));
        }

        // Filter berdasarkan tanggal
        const selectedFilterType = filterType.value;
        const selectedDate = new Date(filterDate.value);

        if (selectedFilterType === 'date' && !isNaN(selectedDate)) {
            filtered = filtered.filter(tx => {
                const txDate = new Date(tx.date);
                return txDate.toDateString() === selectedDate.toDateString();
            });
        } else if (selectedFilterType === 'month' && !isNaN(selectedDate)) {
            filtered = filtered.filter(tx => {
                const txDate = new Date(tx.date);
                return txDate.getMonth() === selectedDate.getMonth() && txDate.getFullYear() === selectedDate.getFullYear();
            });
        } else if (selectedFilterType === 'year' && !isNaN(selectedDate)) {
            filtered = filtered.filter(tx => {
                const txDate = new Date(tx.date);
                return txDate.getFullYear() === selectedDate.getFullYear();
            });
        }

        if (filtered.length === 0) {
            noHistory.style.display = 'block';
            return;
        }
        noHistory.style.display = 'none';
        filtered.forEach((tx) => {
            const li = document.createElement('li');
            li.style.background = '#fff';
            li.style.borderRadius = '10px';
            li.style.margin = '5px 0';
            li.style.padding = '10px';
            li.style.display = 'flex';
            li.style.justifyContent = 'space-between';
            li.style.alignItems = 'center';
            li.style.boxShadow = '0 2px 6px rgba(0,0,0,0.05)';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'info';
            infoDiv.style.flex = '1';
            infoDiv.style.marginRight = '10px';

            const typeText = tx.type === 'pemasukan' ? 'Pemasukan' : 'Pengeluaran';
            infoDiv.innerHTML = `<strong>${typeText}</strong><br>
                ${formatDateDisplay(tx.date)}<br>
                <em>${tx.category}</em>`;

            const amountDiv = document.createElement('div');
            amountDiv.className = 'amount ' + (tx.type === 'pemasukan' ? 'income' : 'expense');
            amountDiv.textContent = formatRp(tx.amount);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'actions';
            actionsDiv.style.display = 'flex';
            actionsDiv.style.gap = '8px';

            const editBtn = document.createElement('button');
            editBtn.setAttribute('aria-label', 'Edit transaksi');
            editBtn.title = 'Edit';
            editBtn.className = 'edit';
            editBtn.style.background = 'none';
            editBtn.style.border = 'none';
            editBtn.style.cursor = 'pointer';
            editBtn.style.padding = '4px';
            editBtn.style.color = '#2980b9';
            editBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20" viewBox="0 0 24 24">
                <path d="M12 20h9"></path>
                <path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4 12.5-12.5z"></path>
            </svg>`;

            const actualIndex = transactions.indexOf(tx);
            editBtn.addEventListener('click', () => {
                showForm(tx.type, actualIndex);
                tabs.forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-pressed', 'false');
                });
                document.querySelector('[data-tab="transaction"]').classList.add('active');
                document.querySelector('[data-tab="transaction"]').setAttribute('aria-pressed', 'true');
                sections.forEach(s => s.style.display = 'none');
                document.getElementById('transaction').style.display = 'flex';
            });

            const delBtn = document.createElement('button');
            delBtn.setAttribute('aria-label', 'Hapus transaksi');
            delBtn.title = 'Hapus';
            delBtn.className = 'delete';
            delBtn.style.background = 'none';
            delBtn.style.border = 'none';
            delBtn.style.cursor = 'pointer';
            delBtn.style.padding = '4px';
            delBtn.style.color = '#c0392b';
            delBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20" viewBox="0 0 24 24">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6l-2 14a2 2 0 01-2 2H9a2 2 0 01-2-2L5 6"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
                <path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"></path>
            </svg>`;

            delBtn.addEventListener('click', () => {
                if (confirm('Anda yakin ingin menghapus transaksi ini?')) {
                    transactions.splice(actualIndex, 1);
                    saveTransactions();
                    renderHistory(historySearch.value);
                    updateDashboard();
                    updateChartData();
                }
            });

            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(delBtn);

            li.appendChild(infoDiv);
            li.appendChild(amountDiv);
            li.appendChild(actionsDiv);

            historyList.appendChild(li);
        });
    }

    transactionForm.addEventListener('submit', e => {
        e.preventDefault();
        const type = btnPemasukan.getAttribute('aria-pressed') === 'true' ? 'pemasukan' : 'pengeluaran';
        const rawJumlah = jumlahInput.value.replace(/\./g, '');
        const jumlahNum = parseInt(rawJumlah, 10);
        if (!jumlahNum || jumlahNum <= 0) {
            alert('Mohon masukkan jumlah yang valid.');
            jumlahInput.focus();
            return;
        }
        const tanggal = tanggalInput.value;
        if (!tanggal) {
            alert('Mohon pilih tanggal.');
            tanggalInput.focus();
            return;
        }
        let kategori = kategoriInput.value.trim();
        if (!kategori) kategori = 'Lainnya';

        if (editIndex >= 0) {
            transactions[editIndex] = {
                amount: jumlahNum,
                date: tanggal,
                category: kategori,
                type: type,
            };
        } else {
            transactions.push({
                amount: jumlahNum,
                date: tanggal,
                category: kategori,
                type: type,
            });
        }

        saveTransactions();
        transactionForm.reset();
        transactionForm.style.display = 'none';
        editIndex = -1;
        btnPemasukan.setAttribute('aria-pressed', 'false');
        btnPengeluaran.setAttribute('aria-pressed', 'false');
        selectedTransactionType = null;
        btnPemasukan.classList.remove('expanded');
        btnPemasukan.classList.remove('collapsed');
        btnPengeluaran.classList.remove('expanded');
        btnPengeluaran.classList.remove('collapsed');
        renderHistory();
        updateDashboard();
        updateChartData();
    });

    historySearch.addEventListener('input', () => {
        renderHistory(historySearch.value);
    });

    filterType.addEventListener('change', () => {
        renderHistory(historySearch.value);
    });

    filterDate.addEventListener('change', () => {
        renderHistory(historySearch.value);
    });

    // Chart initialization
    const ctx = document.getElementById('financeChart').getContext('2d');
    let chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Pemasukan',
                    data: [],
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.2)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 5
                },
                {
                    label: 'Pengeluaran',
                    data: [],
                    borderColor: '#c0392b',
                    backgroundColor: 'rgba(192, 57, 43, 0.2)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'Rp ' + value.toLocaleString('id-ID');
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 14,
                            weight: '600'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': Rp ' + context.parsed.y.toLocaleString('id-ID');
                        }
                    }
                }
            }
        }
    });

    updateDashboard();
    renderHistory();
    updateChartData();

    document.querySelectorAll('.chart-controls button').forEach(button => {
        button.addEventListener('click', () => {
            if (button.dataset.range === currentRange) return;
            currentRange = button.dataset.range;
            document.querySelectorAll('.chart-controls button').forEach(b => {
                b.classList.remove('active');
                b.setAttribute('aria-pressed', 'false');
            });
            button.classList.add('active');
            button.setAttribute('aria-pressed', 'true');
            updateChartData();
            updateDashboard(); // Tambahkan ini untuk memperbarui dashboard
        });
    });
})();
</script>
</body>
</html>

